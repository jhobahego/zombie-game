# Copilot Instructions

- **App shape**: Next.js (App Router) single-page game at `src/app/page.tsx` using custom AI UI primitives in `src/components/ai-elements`. Entry hooks into `useZombieGame` to manage chat-like flow, images, and loading state.
- **Story flow**: `useZombieGame` starts the game on mount (calls `/api/generate-story` with `isStart: true`), stores messages (`GameMessage` in `src/lib/types.d.ts`), then triggers `/api/generate-image` once a story arrives. Subsequent user input posts `{ userMessage, conversationHistory, isStart: false }` and appends an assistant message with a pending image.
- **API contracts (text/img)**: `/api/generate-story` expects `{ userMessage?, conversationHistory?, isStart }` and returns `{ story, imageDescription }`; `/api/generate-image` expects an image prompt. Note a current mismatch: the hook sends `{ description }` but the route reads `imagePrompt`—keep payloads consistent when modifying either side.
- **Generation stack**: Text + image use `@ai-sdk/google` + `ai` (`generateText`) with Gemini models (`gemini-2.0-flash-lite-001` for text, `gemini-2.5-flash-image-preview` for images). Prompts live in `src/lib/prompts.ts` and enforce a trailing `IMAGEN:` separator defined by `GAME_CONFIG.IMAGE.SEPARATOR` in `src/lib/consts.ts`.
- **Audio/TTS**: `/api/generate-audio` uses `@google/genai` (`GAME_CONFIG.AUDIO.MODEL`) to get base64 PCM, wraps it as WAV, and returns JSON. `useAudioPlayer` (`src/hooks/useAudioPlayer.ts`) handles playback (direct or queued) via helpers in `src/lib/audio-utils.ts` (HTMLAudio with Web Audio fallback). Contract alert: the API currently returns `{ audioData, mimeType, duration }`, but the type `GeneratedAudio` expects `{ base64Data, mimeType }` and callers invoke `data.audio`—align these names before extending.
- **UI patterns**: Conversation UI uses `Conversation`/`Message`/`Response`/`Image` components from `ai-elements`; loader at `app/componentes/game-loader.tsx`; input at `app/componentes/game-input.tsx` uses `PromptInput` primitives. Game messages display assistant images with a loading overlay while image generation runs.
- **State rules**: `isLoading` gates input submission; `imageLoading` flags per-message image placeholders. `startGame` runs once in a `useEffect` and seeds the first assistant turn. User messages are appended locally before the story response arrives.
- **Types & media**: `GeneratedImage` requires `{ base64Data, mediaType, uint8ArrayData }`. Audio helpers expect `base64Data` and normalize MIME types. Adjust upstream API responses instead of loosening types to avoid runtime playback issues.
- **Styling**: Global styles in `app/globals.css`; layout sets `lang="es"` and Geist fonts. Background gradient colors come from CSS variables `--color-gradient-principal`/`--color-gradient-secondary` (ensure they exist when theming).
- **Environment**: Requires `GOOGLE_API_KEY` for text/image routes and `GEMINI_API_KEY` for TTS. Validate these before calling external APIs; current code defaults to empty strings.
- **Tooling**: Dev/build with `pnpm dev` / `pnpm build` (Turbopack). Lint/format with `pnpm lint` / `pnpm format` (Biome). Keep files ASCII where possible.
- **Troubleshooting hotspots**: Image prompt separator (`IMAGEN:`) is mandatory for the prompt split; missing it breaks image generation. The generate-image payload name mismatch and TTS response shape mismatch are known edges—fix both together when touching those areas. Audio playback logs extensively; watch browser console for fallback decisions.
- **References**: Core flow `src/app/page.tsx`; hook `src/app/hooks/use-zombie-game.ts`; APIs `src/app/api/*`; prompts/config `src/lib/prompts.ts`, `src/lib/consts.ts`; audio utils `src/lib/audio-utils.ts`; UI wrappers `src/app/componentes/*.tsx`.
